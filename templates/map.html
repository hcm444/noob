var Map = null;
var Planes = {};
var NumPlanes = 0;
var Selected = null;

function getIconForPlane(plane) {
    var triangleSize = 20;
    var rotation = plane.heading || 0;
    var triangleHtml = '<svg height="' + triangleSize +
        '" width="' + triangleSize +
        '" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="red" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(' + rotation + 'deg);">';
    triangleHtml += '<path d="M12 2 L20 21 L12 17 L4 21 Z"></path>';
    triangleHtml += '</svg>';
    var icon = L.divIcon({
        html: triangleHtml,
        className: 'plane-icon',
        iconSize: [triangleSize, triangleSize],
        iconAnchor: [triangleSize / 2, triangleSize / 2],
    });
    return icon;
}

function selectPlane(planehex) {
    if (!Planes[planehex]) return;
    var old = Selected;
    Selected = planehex;
    if (Planes[old]) {
        Planes[old].marker.setIcon(getIconForPlane(Planes[old]));
    }
    Planes[Selected].marker.setIcon(getIconForPlane(Planes[Selected]));
    refreshSelectedInfo();
}

function selectPlaneCallback(hex) {
    return function () {
        if (Selected === hex) {
            Selected = null;
            refreshSelectedInfo();
        } else {
            Selected = hex;
            refreshSelectedInfo();
        }

        for (var planeHex in Planes) {
            var plane = Planes[planeHex];
            plane.marker.setIcon(getIconForPlane(plane));
        }
    };
}

function refreshSelectedInfo() {
    var i = document.getElementById('selinfo');
    var p = Planes[Selected];
    if (!p) return;
    var html = 'ICAO: ' + p.icao24 + '<br>';
    if (p.callsign.length) {
        html += '<b>' + p.callsign + '</b><br>';
    }
    html += 'Altitude: ' + p.altitude + ' feet<br>';
    html += 'Speed: ' + p.speed + ' knots<br>';
    html += 'Coordinates: ' + p.latitude + ', ' + p.longitude + '<br>';
    i.innerHTML = html;
}

function fetchData() {
    $.getJSON('/api2', function (data) {
        var stillhere = {};

        for (var j = 0; j < data.length; j++) {
            var plane = data[j];
            var marker = null;
            stillhere[plane.icao24] = true;

            var icao24 = plane.icao24;
            var callsign = plane.callsign;
            var altitude = plane.altitude;
            var speed = plane.speed;
            var latitude = plane.latitude;
            var longitude = plane.longitude;
            var heading = plane.heading;

            var icon = getIconForPlane({
                icao24: icao24,
                altitude: altitude,
                speed: speed,
                latitude: latitude,
                longitude: longitude,
                heading: heading,
                callsign: callsign
            });

            if (Planes[icao24] || Planes[callsign]) {
                var myplane = Planes[icao24];
                marker = myplane.marker;
                marker.setLatLng([latitude, longitude]);
                marker.setIcon(icon);

                myplane.altitude = altitude;
                myplane.speed = speed;
                myplane.latitude = latitude;
                myplane.longitude = longitude;
                myplane.heading = heading;
                myplane.callsign = callsign;

                if (myplane.icao24 == Selected) {
                    refreshSelectedInfo();
                }
            } else {
                marker = L.marker([latitude, longitude], { icon: icon }).addTo(Map);
                marker.on('click', selectPlaneCallback(icao24));

                Planes[icao24] = {
                    icao24: icao24,
                    altitude: altitude,
                    speed: speed,
                    latitude: latitude,
                    longitude: longitude,
                    heading: heading,
                    callsign: callsign,
                    marker: marker
                };
            }
        }

        NumPlanes = Object.keys(stillhere).length;
        refreshGeneralInfo();

        for (var p in Planes) {
            if (!stillhere[p]) {
                Map.removeLayer(Planes[p].marker);
                delete Planes[p];
            }
        }

        var bounds = calculateBounds();
        if (bounds) {
            Map.fitBounds(bounds);
        }
    });
}

function calculateBounds() {
    var minLat = Number.POSITIVE_INFINITY;
    var maxLat = Number.NEGATIVE_INFINITY;
    var minLon = Number.POSITIVE_INFINITY;
    var maxLon = Number.NEGATIVE_INFINITY;

    for (var planeHex in Planes) {
        var plane = Planes[planeHex];
        var lat = plane.latitude;
        var lon = plane.longitude;

        if (lat < minLat) {
            minLat = lat;
        }
        if (lat > maxLat) {
            maxLat = lat;
        }
        if (lon < minLon) {
            minLon = lon;
        }
        if (lon > maxLon) {
            maxLon = lon;
        }
    }

    // Check if there is any valid data
    if (isFinite(minLat) && isFinite(maxLat) && isFinite(minLon) && isFinite(maxLon)) {
        var bounds = [[minLat, minLon], [maxLat, maxLon]];
        return bounds;
    } else {
        return null; // No valid data, return null
    }
}


function refreshGeneralInfo() {
    var i = document.getElementById('geninfo');
    i.innerHTML = NumPlanes + ' aircraft on screen.';
}

function initialize() {
    Map = L.map('map_canvas').setView([37.0, 13.0], 3);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/streets-v11',
        accessToken: 'your.mapbox.access.token'
    }).addTo(Map);

    window.setInterval(function () {
        fetchData();
        refreshGeneralInfo();
    }, 100);
}
</script>
